# Phase 1 Audit Findings & Fix Plan

## 1. Status Check

- **Monorepo with apps/web, apps/studio, packages/ui, packages/schemas, scripts** — PARTIAL — Repo structure exists, but `packages/schemas` still exports nothing so shared schemas are not centralized. 【F:packages/schemas/index.ts†L1-L4】
- **ShadcnBlocks page builder integrated via SectionRenderer** — PARTIAL — SectionRenderer only routes six `_type` values to registries, leaving other shipped sections outside the pipeline. 【F:apps/web/components/SectionRenderer.tsx†L56-L78】
- **Design system tokens documented in /packages/ui and enforced in Tailwind** — DONE — The design-system guide documents the token sources, shared preset, and usage expectations. 【F:DESIGN_SYSTEM.md†L9-L140】
- **Every block schema exposes a `variant` dropdown** — PARTIAL — Blocks like `carousel-1` ship sizing and color fields but no `variant`, so editors cannot drive presentation variants. 【F:apps/studio/sanity/schemas/blocks/carousel/carousel-1.ts†L10-L68】
- **Frontend variant registries power rendering** — PARTIAL — Registries exist, yet SectionRenderer’s map omits types such as section-header, split-row, timeline, and forms so those components bypass the registry path. 【F:apps/web/components/SectionRenderer.tsx†L56-L78】
- **Central SectionRenderer handles `_type` + `variant` with error handling** — PARTIAL — Component is wired with guards, but because many block types lack registry entries the error path is hit for valid Sanity data. 【F:apps/web/components/SectionRenderer.tsx†L118-L151】
- **Service schema matches roadmap contract** — WRONG — Schema still uses a `blocks` array with category/meta fields instead of the lean sections + structured content contract. 【F:apps/studio/sanity/schemas/documents/service.ts†L23-L156】
- **Location schema matches roadmap contract** — WRONG — Location document mirrors the legacy `blocks` array and lacks coverage areas/operating info fields defined in the roadmap. 【F:apps/studio/sanity/schemas/documents/location.ts†L23-L148】
- **serviceLocationPage schema without slug, computed title, optional sections[] with fallback** — WRONG — Document still defines a required slug and direct `blocks` array rather than deriving URLs from service/location references. 【F:apps/studio/sanity/schemas/documents/service-location.ts†L27-L185】
- **siteSettings schema holds NAP, brand assets, emergency flag, defaultSeo** — PARTIAL — NAP and branding exist, but no `defaultSeo` object is present so routes improvise fallbacks. 【F:apps/studio/sanity/schemas/documents/settings.ts†L1-L214】
- **SEO util composes meta/canonical/JSON-LD for LocalBusiness, FAQ, Breadcrumb** — PARTIAL — Helpers exist, yet routes only merge service and LocalBusiness schemas so FAQ/Breadcrumb JSON-LD never render. 【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L91-L155】【F:apps/web/lib/seo.ts†L84-L142】
- **Dynamic route `/services/[serviceSlug]` uses ISR over service schema** — PARTIAL — Route exists but calls the global `client` without honoring per-request datasets. 【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L1-L88】
- **Dynamic route `/locations/[locationSlug]` uses ISR over location schema** — PARTIAL — Same dataset coupling and missing structured data beyond LocalBusiness. 【F:apps/web/app/(main)/locations/[locationSlug]/page.tsx†L1-L162】
- **Dynamic route `/[serviceSlug]/in/[locationSlug]` with service fallback** — PARTIAL — Route resolves but canonical path conflicts with the duplicate `/locations/.../services/...` route and still depends on the global client. 【F:apps/web/app/(main)/locations/[locationSlug]/services/[serviceSlug]/page.tsx†L1-L205】
- **Fallback logic uses service defaults when serviceLocationPage lacks data** — DONE — The route explicitly falls back to the parent service `blocks` array. 【F:apps/web/app/(main)/locations/[locationSlug]/services/[serviceSlug]/page.tsx†L130-L199】
- **NOINDEX flag wired from schemas into robots meta** — DONE — Pages forward the `noindex` booleans into `generateSEOMetadata`, which handles robots directives. 【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L50-L68】【F:apps/web/lib/seo.ts†L20-L61】
- **`sitemap.xml` generated from active dataset** — WRONG — Sitemap queries use the shared `sanityFetch` without per-request dataset context and include page/post docs outside the Phase 1 scope. 【F:apps/web/app/sitemap.ts†L1-L118】
- **TypeScript/ESLint/Lighthouse/perf gates enforce roadmap thresholds** — PARTIAL — Lighthouse config downgrades SEO to 0.95 and JS bundle to 400KB instead of roadmap-perfect scores. 【F:lighthouserc.js†L21-L56】
- **Deployment to Vercel with dataset defined in env** — PARTIAL — Middleware writes `x-dataset` but `getDataset` reads `x-sanity-dataset`, so dataset overrides never land. 【F:apps/web/lib/domain-middleware.ts†L162-L210】【F:apps/web/sanity/env.ts†L28-L52】
- **Editor workflow (edit hero text, reorder sections, swap variants) verified** — PARTIAL — With missing `variant` fields and registry gaps, several blocks (carousel, section header, forms) cannot swap variants end-to-end. 【F:apps/studio/sanity/schemas/blocks/carousel/carousel-1.ts†L10-L68】【F:apps/web/components/SectionRenderer.tsx†L56-L151】

## 2. Drift / Patch Fixes

- `/locations/[locationSlug]/services/[serviceSlug]/page.tsx`: Hardcoded NAP data for JSON-LD bypasses siteSettings, plus the route duplicates the canonical `/[service]/in/[location]` path. Correct fix: delete this route and drive schema data from siteSettings. 【F:apps/web/app/(main)/locations/[locationSlug]/services/[serviceSlug]/page.tsx†L130-L199】
- `SectionRenderer.tsx`: Registry map omits valid Sanity block types, forcing ad-hoc renderers elsewhere. Fix by registering every `_type` + variant and deleting legacy block maps. 【F:apps/web/components/SectionRenderer.tsx†L56-L151】
- `service.ts`: Content contract still lives in `blocks` with category/meta fields, breaking the lean sections model mandated by the roadmap. Move to {name, slug, seo, sections[]} and push taxonomy elsewhere. 【F:apps/studio/sanity/schemas/documents/service.ts†L23-L156】
- `env.ts` vs `domain-middleware.ts`: Header mismatch (`x-sanity-dataset` vs `x-dataset`) prevents tenant-specific dataset resolution. Align the names and force all routes through `getDataset()`. 【F:apps/web/sanity/env.ts†L28-L52】【F:apps/web/lib/domain-middleware.ts†L162-L210】
- `sitemap.ts`: Uses the shared `sanityFetch` client bound to default dataset and emits page/post docs outside Phase 1. Rebuild with request-aware client returning only service/location/service-location URLs. 【F:apps/web/app/sitemap.ts†L1-L118】
- `carousel-1.ts`: Missing `variant` select blocks editors from choosing display variants. Add the variant field tied to frontend registry keys. 【F:apps/studio/sanity/schemas/blocks/carousel/carousel-1.ts†L10-L68】
- `/services/[serviceSlug]/page.tsx`: Hardcoded “Content coming soon” fallback violates the “all marketing content lives in Sanity sections” rule. Supply fallback sections from Sanity instead. 【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L140-L155】
- `seo.ts`: FAQ generator exists but no integration layer collects FAQ blocks, so structured data never renders. Wire SectionRenderer to aggregate FAQ content and merge it here. 【F:apps/web/lib/seo.ts†L84-L142】
- `service-location.ts`: Requiring a slug defeats the computed URL contract; remove the slug field and derive the path from references. 【F:apps/studio/sanity/schemas/documents/service-location.ts†L27-L185】
- `components/blocks/index.tsx`: Legacy component map duplicates SectionRenderer logic and keeps divergent rendering paths. Delete it once the registry covers every section. 【F:apps/web/components/blocks/index.tsx†L1-L65】

## 3. SEO & Routing Violations

- `/services/[serviceSlug]`: No FAQ or breadcrumb JSON-LD despite available helpers; only Service + LocalBusiness schemas are emitted. Should aggregate FAQ sections and generate breadcrumbs per roadmap. 【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L91-L155】【F:apps/web/lib/seo.ts†L84-L142】
- `/locations/[locationSlug]`: Emits LocalBusiness schema only; breadcrumbs and FAQ schemas are absent, and canonical relies on per-page meta instead of site defaults. Should add breadcrumb chain Home → Locations → City and FAQ JSON-LD. 【F:apps/web/app/(main)/locations/[locationSlug]/page.tsx†L55-L162】
- `/locations/[locationSlug]/services/[serviceSlug]`: Duplicates the expected `/[service]/in/[location]` route and hardcodes schema NAP data, leading to conflicting canonicals. Remove this route and rely on the single canonical pattern. 【F:apps/web/app/(main)/locations/[locationSlug]/services/[serviceSlug]/page.tsx†L63-L199】
- `sitemap.ts`: Queries default dataset through `sanityFetch` and includes `page`/`post` docs, risking cross-tenant leakage. Must use request-scoped dataset and limit to service/location/service-location docs marked active. 【F:apps/web/app/sitemap.ts†L1-L118】
- Global FAQ Schema: FAQ generator is never invoked, so LocalBusiness pages miss the mandated schema enrichment. Integrate FAQ collection via SectionRenderer. 【F:apps/web/lib/seo.ts†L84-L142】

## 4. Schema & Content Model Gaps

- **Service**: Still exposes `blocks`, category references, and meta primitives rather than structured copy/sections, blocking automation and dataset portability. 【F:apps/studio/sanity/schemas/documents/service.ts†L23-L156】
- **Location**: Lacks coverage area, operating hours, and NAP references required for scale; storing SEO strings directly forces frontend fallbacks. 【F:apps/studio/sanity/schemas/documents/location.ts†L23-L148】
- **Service Location**: Keeps a manual slug and independent blocks array, preventing deterministic URLs and weakening fallback logic. 【F:apps/studio/sanity/schemas/documents/service-location.ts†L27-L185】
- **Blocks**: Key blocks (e.g., `carousel-1`) do not surface a `variant` selector, so editors can’t opt into registry variants. 【F:apps/studio/sanity/schemas/blocks/carousel/carousel-1.ts†L10-L68】
- **siteSettings**: No `defaultSeo` bundle exists, so routes improvise meta fallbacks and duplicate strings. 【F:apps/studio/sanity/schemas/documents/settings.ts†L1-L214】
- **Rendering fallback**: Routes inject hardcoded “Content coming soon” messages instead of Sanity-driven fallback sections, fragmenting the content model. 【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L140-L155】【F:apps/web/app/(main)/locations/[locationSlug]/page.tsx†L145-L160】

## 5. Technical Debt Risks

- **Dataset header mismatch**: Without aligning `x-dataset` and `x-sanity-dataset`, multi-tenant dataset isolation can’t work. Fix by using a single header name across middleware and `getDataset`. 【F:apps/web/lib/domain-middleware.ts†L162-L210】【F:apps/web/sanity/env.ts†L28-L52】
- **Placeholder schema package**: Shared schemas/types aren’t exported, blocking future automation tooling. Move Sanity schema definitions into `packages/schemas` and publish types. 【F:packages/schemas/index.ts†L1-L4】
- **Duplicate service-location route**: Extra `/locations/.../services/...` page hardcodes NAP and creates canonical drift; delete it in favor of `/[service]/in/[location]`. 【F:apps/web/app/(main)/locations/[locationSlug]/services/[serviceSlug]/page.tsx†L63-L199】
- **Incomplete SectionRenderer registry**: Missing mappings force divergent rendering strategies and will explode with more tenants. Register every block and remove parallel renderers. 【F:apps/web/components/SectionRenderer.tsx†L56-L151】【F:apps/web/components/blocks/index.tsx†L1-L65】
- **Missing FAQ/Breadcrumb schema wiring**: Structured data gaps reduce SEO automation benefits. Aggregate FAQ blocks and generate breadcrumb JSON-LD in each route. 【F:apps/web/lib/seo.ts†L84-L142】【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L91-L155】
- **Schema drift from roadmap**: Service/location/service-location documents still follow legacy shapes, so future dataset provisioning will fail. Refactor schemas to the roadmap contract and regenerate types. 【F:apps/studio/sanity/schemas/documents/service.ts†L23-L156】【F:apps/studio/sanity/schemas/documents/location.ts†L23-L148】【F:apps/studio/sanity/schemas/documents/service-location.ts†L27-L185】
- **siteSettings lacking SEO defaults**: Without `defaultSeo`, each route reimplements fallbacks, hindering multi-tenant branding updates. Add structured SEO defaults and consume them in SEO helpers. 【F:apps/studio/sanity/schemas/documents/settings.ts†L1-L214】【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L50-L68】
- **Sitemap bound to default dataset**: Using shared `sanityFetch` risks leaking other tenants as soon as multi-client launches. Switch to a request-scoped client. 【F:apps/web/app/sitemap.ts†L1-L118】
- **Relaxed Lighthouse thresholds**: Allowing SEO <100 and JS 400KB weakens CI enforcement, inviting regressions. Restore roadmap thresholds. 【F:lighthouserc.js†L21-L56】
- **Hardcoded fallback copy**: Inline placeholders (“Content coming soon”) break the Sanity-only content principle and create translation debt. Replace with CMS-driven fallback sections. 【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L140-L155】【F:apps/web/app/(main)/locations/[locationSlug]/page.tsx†L145-L160】

## 6. Priority Fix List

1. **Align dataset headers** — Blocks multi-tenant isolation; rename headers to a single value and require all routes to resolve clients via `getDataset`. Files: `apps/web/lib/domain-middleware.ts`, `apps/web/sanity/env.ts`. 【F:apps/web/lib/domain-middleware.ts†L162-L210】【F:apps/web/sanity/env.ts†L28-L52】
2. **Normalize service & location schemas** — Current shapes break automation; refactor to roadmap fields and expose sections[], then regenerate types. Files: `apps/studio/sanity/schemas/documents/service.ts`, `location.ts`. 【F:apps/studio/sanity/schemas/documents/service.ts†L23-L156】【F:apps/studio/sanity/schemas/documents/location.ts†L23-L148】
3. **Fix service-location schema & routing** — Remove slug, compute path from references, and drop the duplicate `/locations/.../services/...` route. Files: `apps/studio/sanity/schemas/documents/service-location.ts`, `apps/web/app/(main)/locations/[locationSlug]/services/[serviceSlug]/page.tsx`. 【F:apps/studio/sanity/schemas/documents/service-location.ts†L27-L185】【F:apps/web/app/(main)/locations/[locationSlug]/services/[serviceSlug]/page.tsx†L63-L199】
4. **Expand SectionRenderer registry coverage** — Missing mappings block rendering; register every section type + variant and delete `components/blocks/index.tsx`. Files: `apps/web/components/SectionRenderer.tsx`, `apps/web/components/blocks/index.tsx`. 【F:apps/web/components/SectionRenderer.tsx†L56-L151】【F:apps/web/components/blocks/index.tsx†L1-L65】
5. **Add variant fields to blocks** — Editors can’t control variants; add `variant` selects (e.g., carousel, section-header) aligned with frontend keys. Files: `apps/studio/sanity/schemas/blocks/*`. 【F:apps/studio/sanity/schemas/blocks/carousel/carousel-1.ts†L10-L68】
6. **Inject FAQ & breadcrumb JSON-LD** — Missing structured data hurts SEO; collect FAQ items and generate breadcrumbs per route. Files: `apps/web/lib/seo.ts`, dynamic route pages. 【F:apps/web/lib/seo.ts†L84-L142】【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L91-L155】
7. **Centralize siteSettings SEO defaults** — Without defaults, routes duplicate meta logic; add `defaultSeo` to settings and consume it in metadata helpers. Files: `apps/studio/sanity/schemas/documents/settings.ts`, `apps/web/lib/seo.ts`, dynamic routes. 【F:apps/studio/sanity/schemas/documents/settings.ts†L1-L214】【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L50-L68】
8. **Rebuild sitemap with request-aware client** — Prevent cross-tenant leakage by using a dataset-aware fetcher limited to service/location/service-location docs. Files: `apps/web/app/sitemap.ts`. 【F:apps/web/app/sitemap.ts†L1-L118】
9. **Restore Lighthouse thresholds** — Ensure CI enforces roadmap gates by raising SEO to 1.0 and JS bundle to 250KB. Files: `lighthouserc.js`. 【F:lighthouserc.js†L21-L56】
10. **Remove hardcoded fallback copy** — Keep marketing copy in Sanity by replacing inline placeholders with CMS-managed fallback sections. Files: service/location pages. 【F:apps/web/app/(main)/services/[serviceSlug]/page.tsx†L140-L155】【F:apps/web/app/(main)/locations/[locationSlug]/page.tsx†L145-L160】
